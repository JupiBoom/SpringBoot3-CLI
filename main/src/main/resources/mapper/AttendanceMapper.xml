<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rosy.main.mapper.AttendanceMapper">

    <resultMap id="BaseResultMap" type="com.rosy.main.domain.entity.Attendance">
        <id column="id" property="id"/>
        <result column="course_id" property="courseId"/>
        <result column="student_id" property="studentId"/>
        <result column="attend_date" property="attendDate"/>
        <result column="status" property="status"/>
        <result column="sign_time" property="signTime"/>
        <result column="remark" property="remark"/>
        <result column="creator_id" property="creatorId"/>
        <result column="create_time" property="createTime"/>
        <result column="updater_id" property="updaterId"/>
        <result column="update_time" property="updateTime"/>
        <result column="version" property="version"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <select id="getAttendanceStatistics" resultType="java.util.Map">
        SELECT
            student_id AS studentId,
            COUNT(*) AS totalClasses,
            SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) AS normalCount,
            SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS lateCount,
            SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS absentCount,
            SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS leaveCount,
            ROUND((SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) + SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END)) * 100.0 / COUNT(*), 2) AS attendanceRate
        FROM attendance
        WHERE is_deleted = 0
        <if test="courseId != null">
            AND course_id = #{courseId}
        </if>
        GROUP BY student_id
    </select>

    <select id="getStudentAttendanceRate" resultType="java.util.Map">
        SELECT
            student_id AS studentId,
            COUNT(*) AS totalClasses,
            SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) AS normalCount,
            SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS lateCount,
            SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS absentCount,
            SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS leaveCount,
            ROUND((SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) + SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END)) * 100.0 / COUNT(*), 2) AS attendanceRate
        FROM attendance
        WHERE is_deleted = 0 AND student_id = #{studentId}
        GROUP BY student_id
    </select>

</mapper>